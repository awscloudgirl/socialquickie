<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | SocialQuickie</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">

  <!-- Dashboard Container -->
  <div class="bg-white shadow-lg rounded-xl p-8 w-full max-w-lg">
    <h1 class="text-3xl font-bold text-center mb-4">SocialQuickie Dashboard</h1>
    <p id="user-email" class="text-center text-gray-600 mb-6"></p>

    <!-- Profile Section -->
    <div id="profile-section" class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Profile</h2>
      <p class="text-gray-500">You’re logged in — manage your products below.</p>
    </div>

    <!-- Add Product Section -->
    <div class="mt-8 bg-gray-50 p-6 rounded-lg shadow-inner">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Add a Product</h2>

      <input id="product-name" placeholder="Product name" class="w-full border p-2 mb-3 rounded" />
      <textarea id="product-description" placeholder="Product description" class="w-full border p-2 mb-3 rounded"></textarea>
      <input id="product-price" type="number" placeholder="Price (USD)" class="w-full border p-2 mb-3 rounded" />
      <input id="product-image" placeholder="Image URL (optional)" class="w-full border p-2 mb-3 rounded" />
      <input id="file-path" placeholder="File path in Supabase (e.g. downloads/ebook.pdf)" class="w-full border p-2 mb-3 rounded" />

      <button id="save-product" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition">
        💾 Save Product
      </button>
    </div>

    <!-- Product List Section -->
    <div id="product-list" class="mt-10">
      <h2 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Your Products</h2>
      <ul id="products" class="space-y-3 text-gray-700"></ul>
    </div>

    <!-- Logout -->
    <button id="logout"
            class="mt-8 w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 transition">
      🚪 Log Out
    </button>
  </div>

  <!-- Supabase Client -->
  <script type="module">
    import { supabase } from './lib/supabaseClient.js'

    // ✅ Check for logged-in user
    async function checkUser() {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        window.location.href = './auth.html'
        return
      }
      document.getElementById('user-email').textContent = `Logged in as ${user.email}`
      loadProducts(user.id)
    }

    // ✅ Save product to Supabase
    document.getElementById('save-product').addEventListener('click', async () => {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        alert('Session expired. Please log in again.')
        window.location.href = './auth.html'
        return
      }

      const name = document.getElementById('product-name').value.trim()
      const description = document.getElementById('product-description').value.trim()
      const price = parseFloat(document.getElementById('product-price').value)
      const image_url = document.getElementById('product-image').value.trim()
      const file_path = document.getElementById('file-path').value.trim()

      if (!name || !price) {
        alert('Please enter at least a name and price.')
        return
      }

      // 🔹 Generate slug
      const slug = name.toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "")
        .substring(0, 100) // safe slug length

      const { error } = await supabase.from('products').insert({
        user_id: user.id,
        name,
        description,
        price: Math.round(price * 100), // store in cents
        image_url,
        file_path,
        slug
      })

      if (error) {
        console.error(error)
        alert('❌ Failed to save product.')
      } else {
        alert('✅ Product saved!')
        loadProducts(user.id)
        document.querySelectorAll('#product-name,#product-description,#product-price,#product-image,#file-path')
          .forEach(i => i.value = '')
      }
    })

    // ✅ Load user products
    async function loadProducts(userId) {
      const { data, error } = await supabase
        .from('products')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })

      const list = document.getElementById('products')
      list.innerHTML = ''

      if (error) {
        console.error(error)
        list.innerHTML = `<li class="text-red-500">Error loading products</li>`
        return
      }

      if (!data.length) {
        list.innerHTML = `<li class="text-gray-400 text-sm">No products yet. Add one above 👆</li>`
        return
      }

      data.forEach(prod => {
        const li = document.createElement('li')
        li.className = 'p-4 bg-white shadow rounded space-y-2'

        const siteUrl = window.location.origin
        const publicPage = prod.slug ? `${siteUrl}/link/${prod.slug}` : '#'

        li.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">${prod.name}</p>
              <p class="text-sm text-gray-500">$${(prod.price / 100).toFixed(2)}</p>
            </div>
            ${prod.image_url ? `<img src="${prod.image_url}" alt="${prod.name}" class="w-10 h-10 object-cover rounded">` : ''}
          </div>

          <div class="flex flex-col space-y-2 mt-3">
            ${prod.slug ? `
              <a href="${publicPage}" target="_blank" class="text-blue-600 underline text-sm">
                🌐 View Public Page
              </a>
              <div class="flex items-center space-x-2">
                <input readonly value="${publicPage}" class="border text-sm px-2 py-1 w-full rounded text-gray-600">
                <button class="text-xs bg-gray-200 px-2 py-1 rounded" onclick="navigator.clipboard.writeText('${publicPage}')">Copy</button>
              </div>` 
              : `<p class="text-gray-400 text-sm">Slug missing. Re-save product.</p>`}
          </div>
        `
        list.appendChild(li)
      })
    }

    // ✅ Logout
    document.getElementById('logout').addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.href = './auth.html'
    })

    checkUser()
  </script>
</body>
</html>